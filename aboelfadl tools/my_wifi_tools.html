<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù…ÙˆÙ„Ø¯ Ø±Ù…ÙˆØ² WiFi QR</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 20px; transition: background 0.3s, color 0.3s; }
    .dark-mode { background-color: #121212; color: #eee; }
    .dark-mode .form-control, .dark-mode select, .dark-mode .input-group-text { background-color: #1e1e1e; color: #fff; border-color: #555; }
    .qr-card { background: #fff; border-radius: 15px; padding: 15px; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin-bottom: 20px; text-align: center; }
    .dark-mode .qr-card { background: #1e1e1e; }
    .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; }
    .toast { padding: 10px 15px; background: #333; color: #fff; border-radius: 5px; margin-top: 10px; animation: fadeInOut 4s; }
    @keyframes fadeInOut { 0% { opacity: 0 } 10% { opacity: 1 } 90% { opacity: 1 } 100% { opacity: 0 } }
    .form-check-input { margin-left: 10px; }
    .filter-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
    .qr-scroll-container { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; scroll-snap-type: x mandatory; }
    .qr-scroll-container .qr-card { min-width: 250px; scroll-snap-align: start; }
    /* --- New Style from wifi_qr_password_check --- */
    #passwordStrengthBar { height: 5px; border-radius: 5px; margin-top: 5px; transition: width 0.4s ease-in-out; }
    .password-display { display: flex; align-items: center; justify-content: center; gap: 5px; margin-top: 10px; }
    .password-display span { font-weight: bold; }
    .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; text-align: center; color: #888; font-size: 0.9em; }
    .dark-mode .footer { border-top-color: #333; color: #bbb; }
  </style>
</head>
<body>
<div class="container">
  <div class="d-flex justify-content-end align-items-center mb-3">
    <div class="form-check form-switch me-3">
      <input class="form-check-input" type="checkbox" id="autoDarkModeToggle">
      <label class="form-check-label" for="autoDarkModeToggle">ÙˆØ¶Ø¹ Ù„ÙŠÙ„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ</label>
    </div>
    <button id="darkModeToggle" class="btn btn-secondary">ğŸŒ“ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹</button>
  </div>
  <h3 class="mb-4">ğŸ” Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² QR Ù„Ø´Ø¨ÙƒØ© WiFi</h3>
  <div class="row g-2 mb-3">
    <div class="col-md-4"><input id="ssid" class="form-control" placeholder="ğŸ”¤ Ø§Ø³Ù… Ø§Ù„Ø´Ø¨ÙƒØ©"></div>
    <div class="col-md-4"><input id="note" class="form-control" placeholder="ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></div>
    <div class="col-md-4">
      <div class="input-group">
        <input id="password" class="form-control" placeholder="ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" oninput="checkPasswordStrength(this.value)">
        <button class="btn btn-outline-secondary" type="button" onclick="generateStrongPassword()">ğŸ”‘</button>
      </div>
      <div class="w-100">
        <div id="passwordStrengthBar" class="bg-danger"></div>
        <small id="passwordStrengthText" class="text-muted"></small>
        <small id="passwordSecurityTips" class="text-info mt-1" style="display: block;"></small>
      </div>
    </div>
    <div class="col-md-4">
      <select id="encryption" class="form-control" onchange="updateEncryptionTip()">
        <option value="WPA">WPA/WPA2</option>
        <option value="WEP">WEP</option>
        <option value="nopass">Ø¨Ø¯ÙˆÙ† ØªØ´ÙÙŠØ±</option>
      </select>
      <small id="encryptionTip" class="text-muted mt-1" style="display: block;"></small>
    </div>
    <div class="col-md-4 mb-3 form-check form-switch">
      <input class="form-check-input" type="checkbox" id="hiddenNetwork">
      <label class="form-check-label" for="hiddenNetwork">Ø´Ø¨ÙƒØ© Ù…Ø®ÙÙŠØ©</label>
    </div>
  </div>
  <div class="mb-3">
    <button onclick="generateQRCode()" class="btn btn-dark">âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø²</button>
    <button onclick="downloadQRCode()" class="btn btn-success">ğŸ“¥ ØªØ­Ù…ÙŠÙ„</button>
    <button onclick="printQRCode()" class="btn btn-info">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    <button onclick="shareQRCode()" class="btn btn-primary" id="shareButton" style="display:none;">ğŸ“² Ù…Ø´Ø§Ø±ÙƒØ©</button>
  </div>
  <div class="mb-3">
    <input type="file" accept="image/*" onchange="decodeQRCodeFromImage(this)" class="form-control" />
  </div>
  <div id="qrcode" class="my-4"></div>
  <div id="extractedInfo" class="alert alert-info" style="display:none;"></div>
  <hr>
  <div class="filter-group">
    <input type="text" id="searchInput" oninput="renderSavedQRCodes()" class="form-control" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø´Ø¨ÙƒØ© Ø£Ùˆ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©">
    <select id="encryptionFilter" class="form-control" onchange="renderSavedQRCodes()">
      <option value="">ğŸ“‚ ÙƒÙ„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ØªØ´ÙÙŠØ±</option>
      <option value="WPA">WPA</option>
      <option value="WEP">WEP</option>
      <option value="nopass">Ø¨Ø¯ÙˆÙ†</option>
    </select>
    <button onclick="exportJSON()" class="btn btn-outline-primary">ğŸ“¤ ØªØµØ¯ÙŠØ±</button>
    <input type="file" accept="application/json" onchange="importJSON(event)" class="form-control">
  </div>
  <button onclick="clearSelected()" class="btn btn-danger mb-2">ğŸ—‘ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
  <p id="encryptionStats"></p>
  <div class="qr-scroll-container" id="savedQRCodes"></div>
</div>
<div class="toast-container" id="toastContainer"></div>

<footer class="footer">
  <p>&copy; 2025 <a href="https://aboelfadl-tools.netlify.app/" target="_blank">AboElfadl</a> - Ø¨ÙˆØ§Ø³Ø·Ø© Ù…Ø­Ù…ÙˆØ¯ Ø£Ø¨Ùˆ Ø§Ù„ÙØ¶Ù„. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p>
</footer>

<script>
const ssidEl = document.getElementById("ssid");
const passwordEl = document.getElementById("password");
const encryptionEl = document.getElementById("encryption");
const noteEl = document.getElementById("note");
const extractedInfo = document.getElementById("extractedInfo");

const toast = (msg, success = true) => {
  const el = document.createElement("div");
  el.className = "toast";
  el.style.backgroundColor = success ? '#28a745' : '#dc3545';
  el.innerText = msg;
  document.getElementById("toastContainer").appendChild(el);
  setTimeout(() => el.remove(), 4000);
};

const applyDarkModeBasedOnTime = () => {
    const hr = new Date().getHours();
    if (hr >= 20 || hr < 6) { // Ù…Ù† 8 Ù…Ø³Ø§Ø¡Ù‹ Ø­ØªÙ‰ 6 ØµØ¨Ø§Ø­Ù‹Ø§
        document.body.classList.add("dark-mode");
    } else {
        document.body.classList.remove("dark-mode");
    }
};

const toggleDarkModeManually = () => {
  document.body.classList.toggle("dark-mode");
  document.getElementById("autoDarkModeToggle").checked = false;
  localStorage.setItem('autoDarkMode', 'false');
};

const handleAutoDarkModeToggle = () => {
    const isAuto = document.getElementById("autoDarkModeToggle").checked;
    localStorage.setItem('autoDarkMode', isAuto);
    if (isAuto) {
        applyDarkModeBasedOnTime();
    } else {
        document.body.classList.remove("dark-mode");
    }
};

function checkPasswordStrength(password) {
  const bar = document.getElementById("passwordStrengthBar");
  const text = document.getElementById("passwordStrengthText");
  const tips = document.getElementById("passwordSecurityTips");
  let strength = 0;
  let tipText = "";

  if (password.length >= 8) strength++; else tipText += "âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù„Ø§ ØªÙ‚Ù„ Ø¹Ù† 8 Ø£Ø­Ø±Ù/Ø£Ø±Ù‚Ø§Ù…. ";
  if (/[A-Z]/.test(password)) strength++; else tipText += "Ø­Ø±Ù ÙƒØ¨ÙŠØ±. ";
  if (/[a-z]/.test(password)) strength++; else tipText += "Ø­Ø±Ù ØµØºÙŠØ±. ";
  if (/\d/.test(password)) strength++; else tipText += "Ø±Ù‚Ù…. ";
  if (/[^A-Za-z0-9]/.test(password)) strength++; else tipText += "Ø±Ù…Ø² Ø®Ø§Øµ. ";

  if (password.length > 0 && !/^[A-Za-z0-9!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]*$/.test(password)) {
    tipText += "âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØªÙ‚Ø¨Ù„ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙÙ‚Ø·. ";
  }

  if (strength <= 1) {
    bar.style.width = "20%";
    bar.className = "bg-danger";
    text.innerText = "Ø¶Ø¹ÙŠÙØ©";
  } else if (strength <= 3) {
    bar.style.width = "60%";
    bar.className = "bg-warning";
    text.innerText = "Ù…ØªÙˆØ³Ø·Ø©";
  } else {
    bar.style.width = "100%";
    bar.className = "bg-success";
    text.innerText = "Ù‚ÙˆÙŠØ©";
  }
  tips.innerText = tipText || "Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø²ÙŠØ¬Ù‹Ø§ Ù…Ù† Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„ÙƒØ¨ÙŠØ±Ø©ØŒ Ø§Ù„ØµØºÙŠØ±Ø©ØŒ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…ØŒ ÙˆØ§Ù„Ø±Ù…ÙˆØ² Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø£Ù…Ø§Ù†.";
}

function updateEncryptionTip() {
    const encryptionType = encryptionEl.value;
    const tipElement = document.getElementById("encryptionTip");
    if (encryptionType === "WPA") {
        tipElement.innerText = "ÙŠÙ†ØµØ­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… WPA/WPA2 Ù„Ø£Ù…Ø§Ù† Ø£Ø¹Ù„Ù‰. Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„ØªØ´ÙÙŠØ± Ø§Ù„Ø£ÙƒØ«Ø± Ø£Ù…Ø§Ù†Ø§Ù‹ Ù„Ù„Ø´Ø¨ÙƒØ§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø©.";
    } else if (encryptionType === "WEP") {
        tipElement.innerText = "WEP ÙŠØ¹ØªØ¨Ø± Ù‚Ø¯ÙŠÙ…Ø§Ù‹ ÙˆØ£Ù‚Ù„ Ø£Ù…Ø§Ù†Ù‹Ø§ØŒ ÙˆÙ„Ø§ ÙŠÙˆØµÙ‰ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù„Ù„Ø´Ø¨ÙƒØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.";
    } else { // nopass
        tipElement.innerText = "Ø¨Ø¯ÙˆÙ† ØªØ´ÙÙŠØ±: Ù„Ø§ ØªÙˆÙØ± Ø£ÙŠ Ø­Ù…Ø§ÙŠØ© Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø§Ø³ØªØ®Ø¯Ù…Ù‡ Ø¨Ø­Ø°Ø± Ø´Ø¯ÙŠØ¯.";
    }
}

document.addEventListener("DOMContentLoaded", () => {
    const darkModeToggleBtn = document.getElementById("darkModeToggle");
    const autoDarkModeCheckbox = document.getElementById("autoDarkModeToggle");
    const savedAutoDarkMode = localStorage.getItem('autoDarkMode');
    if (savedAutoDarkMode === 'true') {
        autoDarkModeCheckbox.checked = true;
        applyDarkModeBasedOnTime();
    } else {
        autoDarkModeCheckbox.checked = false;
        document.body.classList.remove("dark-mode");
    }
    darkModeToggleBtn.addEventListener("click", toggleDarkModeManually);
    autoDarkModeCheckbox.addEventListener("change", handleAutoDarkModeToggle);
    renderSavedQRCodes();
    updateEncryptionTip(); // Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ù†ØµÙŠØ­Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    if (navigator.share) { // Ø§Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ØªØµÙØ­ ÙŠØ¯Ø¹Ù…Ù‡Ø§
      document.getElementById("shareButton").style.display = 'inline-block';
    }
});

function generateQRCode() {
  const ssid = ssidEl.value.trim();
  const password = passwordEl.value;
  const type = encryptionEl.value;
  const hidden = document.getElementById("hiddenNetwork").checked ? 'H:true;' : '';
  const note = noteEl.value.trim();

  if (!ssid) {
      return toast("âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø´Ø¨ÙƒØ©", false);
  }

  if (type !== "nopass") {
      const englishOnlyRegex = /^[A-Za-z0-9!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]*$/;
      if (!englishOnlyRegex.test(password)) {
          return toast("âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø­Ø±Ù ÙˆØ£Ø±Ù‚Ø§Ù… ÙˆØ±Ù…ÙˆØ² Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙÙ‚Ø·.", false);
      }
      if (password.length < 8) {
          return toast("âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù„Ø§ ØªÙ‚Ù„ Ø¹Ù† 8 Ø£Ø­Ø±Ù Ø£Ùˆ Ø£Ø±Ù‚Ø§Ù….", false);
      }
  }
  
  const existing = JSON.parse(localStorage.getItem("qrList") || "[]");
  if (existing.find(e => e.ssid === ssid)) return toast("âš ï¸ Ø§Ù„Ø´Ø¨ÙƒØ© Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø³Ø¨Ù‚Ù‹Ø§", false);
  
  const data = `WIFI:T:${type};S:${ssid};P:${password};${hidden};`;
  qrcode.innerHTML = "";
  new QRCode(qrcode, { text: data, width: 200, height: 200 });
  
  existing.push({ ssid, data, date: new Date().toLocaleString(), note: note });
  localStorage.setItem("qrList", JSON.stringify(existing));
  renderSavedQRCodes();
  toast("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ù…Ø² Ø¨Ù†Ø¬Ø§Ø­");
}

function downloadQRCode() {
  const ssid = ssidEl.value || 'wifi';
  const canvas = qrcode.querySelector("canvas");
  if (!canvas) return toast("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù…Ø²", false);
  const a = document.createElement("a");
  a.href = canvas.toDataURL("image/png");
  a.download = `qr_wifi_${ssid}.png`;
  a.click();
}

async function shareQRCode() {
  const canvas = qrcode.querySelector("canvas");
  if (!canvas) {
    toast("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù…Ø² Ù„Ù…Ø´Ø§Ø±ÙƒØªÙ‡", false);
    return;
  }

  try {
    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
    const filesArray = [new File([blob], 'qrcode.png', { type: 'image/png' })];

    if (navigator.canShare && navigator.canShare({ files: filesArray })) {
      await navigator.share({
        files: filesArray,
        title: 'Ø±Ù…Ø² QR Ù„Ø´Ø¨ÙƒØ© WiFi',
        text: 'Ø¥Ù„ÙŠÙƒ Ø±Ù…Ø² QR Ù„Ø´Ø¨ÙƒØ© WiFi. Ù‚Ù… Ø¨Ù…Ø³Ø­Ù‡ Ù„Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ© Ø¨Ø³Ù‡ÙˆÙ„Ø©.',
      });
      toast("âœ… ØªÙ… Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø±Ù…Ø² Ø¨Ù†Ø¬Ø§Ø­");
    } else {
      toast("âŒ Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù„ÙØ§Øª.", false);
    }
  } catch (error) {
    console.error('Error sharing:', error);
    toast("âŒ ÙØ´Ù„ ÙÙŠ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø±Ù…Ø².", false);
  }
}


function decodeQRCodeFromImage(input) {
  const file = input.files[0];
  if (!file) return;
  extractedInfo.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
  const reader = new FileReader();
  reader.onload = () => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement("canvas");
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, canvas.width, canvas.height);
      if (code && code.data.includes("WIFI:")) {
        const ssid = (code.data.match(/S:([^;]*)/) || [])[1] || "";
        const pass = (code.data.match(/P:([^;]*)/) || [])[1] || "";
        const hiddenStatus = code.data.includes('H:true;') ? ' (Ù…Ø®ÙÙŠØ©)' : '';
        extractedInfo.innerHTML = `
          <p>ğŸ“¡ Ø§Ø³Ù… Ø§Ù„Ø´Ø¨ÙƒØ©: <strong>${ssid}${hiddenStatus}</strong> <button class="btn btn-sm btn-outline-primary" onclick="navigator.clipboard.writeText('${ssid}')">Ù†Ø³Ø®</button></p>
          <p>ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: <strong><span id="decodedPassword">${pass.replace(/./g, '*')}</span></strong> <button class="btn btn-sm btn-outline-primary" onclick="togglePasswordVisibility('decodedPassword', this)">ğŸ‘ï¸</button> <button class="btn btn-sm btn-outline-primary" onclick="navigator.clipboard.writeText('${pass}')">Ù†Ø³Ø®</button></p>
        `;
        extractedInfo.style.display = 'block'; // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
        const existing = JSON.parse(localStorage.getItem("qrList") || "[]");
        if (!existing.find(e => e.ssid === ssid)) {
          existing.push({ ssid, data: code.data, date: new Date().toLocaleString(), note: '' }); // Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø³ØªÙƒÙˆÙ† ÙØ§Ø±ØºØ© Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
          localStorage.setItem("qrList", JSON.stringify(existing));
          renderSavedQRCodes();
        }
      } else {
        toast("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù…Ø² WiFi ØµØ§Ù„Ø­", false);
        extractedInfo.style.display = 'none';
      }
    };
    img.src = reader.result;
  };
  reader.readAsDataURL(file);
}

function togglePasswordVisibility(id, button) {
    const span = document.getElementById(id);
    if (span.dataset.hidden === 'true' || span.dataset.hidden === undefined) {
        span.innerText = span.dataset.password;
        button.innerText = 'ğŸ™ˆ';
        span.dataset.hidden = 'false';
    } else {
        span.innerText = span.dataset.password.replace(/./g, '*');
        button.innerText = 'ğŸ‘ï¸';
        span.dataset.hidden = 'true';
    }
}


function renderSavedQRCodes() {
  const qrs = JSON.parse(localStorage.getItem("qrList") || "[]");
  const container = document.getElementById("savedQRCodes");
  const filter = encryptionFilter.value;
  const search = searchInput.value.toLowerCase();
  container.innerHTML = "";
  const stats = { WPA: 0, WEP: 0, nopass: 0 };
  qrs.forEach((qr, i) => {
    const enc = (qr.data.match(/T:([^;]*)/) || [])[1];
    stats[enc] = (stats[enc] || 0) + 1;
    
    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ø³Ù… Ø§Ù„Ø´Ø¨ÙƒØ© Ø£Ùˆ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©
    const qrText = `${qr.ssid} ${qr.note || ''}`.toLowerCase();
    if (filter && enc !== filter) return;
    if (!qrText.includes(search)) return;

    const pass = (qr.data.match(/P:([^;]*)/) || [])[1] || "";
    let encryptionIcon = '';
    if (enc === 'WPA') encryptionIcon = 'ğŸ”’';
    else if (enc === 'WEP') encryptionIcon = 'ğŸ”“';
    else if (enc === 'nopass') encryptionIcon = 'ğŸš«';

    const col = document.createElement("div");
    col.className = "";
    const card = document.createElement("div");
    card.className = "qr-card";
    card.innerHTML = `
      <input type='checkbox' data-i='${i}' class='form-check-input'>
      <h6>${encryptionIcon} ${qr.ssid}</h6>
      ${qr.note ? `<p class='small text-muted'>${qr.note}</p>` : ''}
      <div id='qr-${i}'></div>
      <div class="password-display">
        <span>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: </span>
        <span id="savedPass-${i}" data-password="${pass}" data-hidden="true">${pass.replace(/./g, '*')}</span>
        <button class="btn btn-sm btn-outline-primary" onclick="togglePasswordVisibility('savedPass-${i}', this)">ğŸ‘ï¸</button>
        <button class="btn btn-sm btn-outline-primary" onclick="navigator.clipboard.writeText('${pass}')">Ù†Ø³Ø®</button>
      </div>
      <p class='small'>ğŸ“… ${qr.date}</p>
      <button class='btn btn-sm btn-outline-secondary' onclick='editQR(${i})'>âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
      <button class='btn btn-sm btn-outline-success' onclick='downloadSaved(${i})'>ğŸ“¥ ØªØ­Ù…ÙŠÙ„</button>
    `;
    col.appendChild(card);
    container.appendChild(col);
    new QRCode(document.getElementById(`qr-${i}`), { text: qr.data, width: 140, height: 140 });
  });
  encryptionStats.textContent = `ğŸ“Š WPA: ${stats.WPA} | WEP: ${stats.WEP} | Ø¨Ø¯ÙˆÙ†: ${stats.nopass}`;
}

function clearSelected() {
  if (!confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø´Ø¨ÙƒØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©ØŸ")) return;
  let qrs = JSON.parse(localStorage.getItem("qrList") || "[]");
  const indices = [...document.querySelectorAll("input[type=checkbox]:checked")].map(e => +e.dataset.i);
  qrs = qrs.filter((_, i) => !indices.includes(i));
  localStorage.setItem("qrList", JSON.stringify(qrs));
  renderSavedQRCodes();
  toast("âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­");
}

function downloadSaved(i) {
  const canvas = document.querySelector(`#qr-${i} canvas`);
  const qrs = JSON.parse(localStorage.getItem("qrList") || "[]");
  const a = document.createElement("a");
  a.href = canvas.toDataURL();
  a.download = `qr_wifi_${qrs[i].ssid}.png`;
  a.click();
}

function editQR(i) {
  const qrs = JSON.parse(localStorage.getItem("qrList") || "[]");
  const qr = qrs[i];
  
  const newSSID = prompt("ğŸ”¤ Ø§Ø³Ù… Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯:", qr.ssid);
  if (newSSID === null) return; // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ù„ØºÙ‰
  
  const newPass = prompt("ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:", (qr.data.match(/P:([^;]*)/) || [])[1] || "");
  if (newPass === null) return; // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ù„ØºÙ‰

  const newNote = prompt("ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):", qr.note || "");
  if (newNote === null) return; // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ù„ØºÙ‰

  const enc = (qr.data.match(/T:([^;]*)/) || [])[1] || "WPA";
  const hidden = qr.data.includes('H:true;') ? 'H:true;' : ''; // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®ÙÙŠ
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ø´Ø¨ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªØ´ÙÙŠØ±
  if (enc !== "nopass") {
      const englishOnlyRegex = /^[A-Za-z0-9!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]*$/;
      if (!englishOnlyRegex.test(newPass)) {
          return toast("âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø­Ø±Ù ÙˆØ£Ø±Ù‚Ø§Ù… ÙˆØ±Ù…ÙˆØ² Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙÙ‚Ø·.", false);
      }
      if (newPass.length < 8) {
          return toast("âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙŠØ¬Ø¨ Ø£Ù„Ø§ ØªÙ‚Ù„ Ø¹Ù† 8 Ø£Ø­Ø±Ù Ø£Ùˆ Ø£Ø±Ù‚Ø§Ù….", false);
      }
  }

  const newData = `WIFI:T:${enc};S:${newSSID};P:${newPass};${hidden};`;
  qrs[i] = { ssid: newSSID, data: newData, date: new Date().toLocaleString(), note: newNote };
  localStorage.setItem("qrList", JSON.stringify(qrs));
  renderSavedQRCodes();
  toast("âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­");
}

function generateStrongPassword() {
  const length = 12; // ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·ÙˆÙ„ Ø­Ø³Ø¨ Ø§Ù„Ø±ØºØ¨Ø©
  const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+~`|}{[]\:;?><,./-=";
  let password = "";
  for (let i = 0, n = charset.length; i < length; ++i) {
    password += charset.charAt(Math.floor(Math.random() * n));
  }
  passwordEl.value = password;
  checkPasswordStrength(password); // ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ù‚ÙˆØ© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
  toast("âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù‚ÙˆÙŠØ©");
}

function printQRCode() {
  const canvas = qrcode.querySelector("canvas");
  const ssid = ssidEl.value.trim();
  const password = passwordEl.value; // Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  const note = noteEl.value.trim();

  if (!canvas) {
    return toast("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù…Ø² Ù„Ø·Ø¨Ø§Ø¹ØªÙ‡", false);
  }

  const printWindow = window.open('', '', 'height=600,width=800');
  printWindow.document.write('<html><head><title>Ø·Ø¨Ø§Ø¹Ø© Ø±Ù…Ø² QR Ù„Ø´Ø¨ÙƒØ© WiFi</title>');
  printWindow.document.write('<style>');
  printWindow.document.write('body { font-family: "Segoe UI", sans-serif; text-align: center; padding: 20px; direction: rtl; }'); // Ø¯Ø¹Ù… RTL Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
  printWindow.document.write('h2 { color: #333; margin-bottom: 25px; }');
  printWindow.document.write('img { border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; max-width: 200px; height: auto; }');
  printWindow.document.write('.info-box { border: 1px solid #eee; padding: 15px; border-radius: 8px; display: inline-block; text-align: right; background-color: #f9f9f9; max-width: 80%; }');
  printWindow.document.write('.info-box p { margin: 5px 0; font-size: 1.1em; }');
  printWindow.document.write('.note-text { font-size: 0.9em; color: #666; margin-top: 10px; }');
  printWindow.document.write('</style>');
  printWindow.document.write('</head><body>');
  printWindow.document.write(`<h2>Ø±Ù…Ø² QR Ù„Ø´Ø¨ÙƒØ© WiFi</h2>`);
  printWindow.document.write(`<img src="${canvas.toDataURL("image/png")}" alt="Ø±Ù…Ø² QR Ù„Ø´Ø¨ÙƒØ© WiFi">`);
  printWindow.document.write('<div class="info-box">');
  printWindow.document.write(`<p><strong>Ø§Ø³Ù… Ø§Ù„Ø´Ø¨ÙƒØ© (SSID):</strong> ${ssid}</p>`);
  printWindow.document.write(`<p><strong>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Password):</strong> <span>${password}</span></p>`);
  printWindow.document.write('<p><i>ÙŠÙ…ÙƒÙ†Ùƒ ÙƒØªØ§Ø¨Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù‡Ù†Ø§: _________________________</i></p>');
  if (note) {
      printWindow.document.write(`<p class="note-text"><strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ${note}</p>`);
  }
  printWindow.document.write('</div>');
  printWindow.document.write('</body></html>');
  printWindow.document.close();
  printWindow.print();
}

function exportJSON() {
  const blob = new Blob([localStorage.getItem("qrList") || "[]"], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "qr_wifi_backup.json";
  a.click();
  toast("âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
}

function importJSON(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const data = JSON.parse(reader.result);
      if (!Array.isArray(data)) return toast("âŒ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯ ØºÙŠØ± ØµØ§Ù„Ø­", false);
      const old = JSON.parse(localStorage.getItem("qrList") || "[]");
      // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù…Ø¹ ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ SSID
      const combined = [...old];
      data.forEach(newItem => {
        if (!combined.some(existingItem => existingItem.ssid === newItem.ssid)) {
          combined.push(newItem);
        }
      });
      localStorage.setItem("qrList", JSON.stringify(combined));
      renderSavedQRCodes();
      toast("âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
    } catch (e) { 
      toast("âŒ ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø£Ùˆ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù", false); 
      console.error("Import error:", e);
    }
  };
  reader.readAsText(file);
}

</script>
</body>
</html>