<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ù„Ù„ Ù…Ø­Ø§Ø¯Ø«Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f0f4f8;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            padding: 30px;
            text-align: center;
        }

        h1 { color: #075e54; margin-bottom: 10px; }
        p { color: #555; margin-bottom: 20px; }

        #upload-area {
            border: 3px dashed #128c7e;
            border-radius: 10px;
            padding: 40px;
            background-color: #e6f8f5;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #upload-area.drag-over { background-color: #d1f0eb; }
        #upload-area p { margin: 0; font-size: 1.2rem; font-weight: 700; color: #075e54; }
        #file-input { display: none; }

        #actions-area { margin-top: 20px; display: none; }
        #results-area { margin-top: 20px; text-align: right; display: none; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }
        
        .stat-card {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .chart-card, .memory-lane-card { grid-column: 1 / -1; }
        .stat-card h3 { margin: 0 0 10px 0; color: #128c7e; font-size: 1.1rem; }
        .stat-card .value { font-size: 1.8rem; font-weight: 700; color: #075e54; }
        .stat-card ol, .stat-card div { padding-right: 20px; text-align: right; }
        .stat-card li, .stat-card p { margin-bottom: 8px; }
        #longest-message-text { font-size: 0.9rem; background-color: #e9ecef; padding: 10px; border-radius: 5px; margin-top: 10px; word-wrap: break-word; text-align: right; }
        
        .memory-item { border-bottom: 1px dashed #ccc; padding-bottom: 10px; margin-bottom: 10px; }
        .memory-item:last-child { border-bottom: none; }
        .memory-item strong { color: #075e54; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; background-color: #128c7e; color: white; }

    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ“Š Ù…Ø­Ù„Ù„ Ù…Ø­Ø§Ø¯Ø«Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨</h1>
        <p>Ø§Ø±ÙØ¹ Ù…Ù„Ù .txt Ø§Ù„Ø®Ø§Øµ Ø¨Ù…Ø­Ø§Ø¯Ø«ØªÙƒ Ù„ØªØ­Ù„ÙŠÙ„Ù‡ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„. Ø®ØµÙˆØµÙŠØªÙƒ Ù…Ø¶Ù…ÙˆÙ†Ø© 100%.</p>
        
        <div id="upload-area">
            <input type="file" id="file-input" accept=".txt">
            <p>Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ù…Ù„Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</p>
        </div>
        
        <div id="actions-area">
            <button id="export-btn" class="btn">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        </div>

        <div id="results-area">
            <div id="stats-grid" class="stats-grid">
                <div class="stat-card"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</h3><div id="total-messages" class="value">0</div></div>
                <div class="stat-card"><h3>Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ† Ø¨Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</h3><div id="participants-list"></div></div>
                <div class="stat-card"><h3>Ø£ÙƒØ«Ø± 5 ÙƒÙ„Ù…Ø§Øª</h3><ol id="top-words"></ol></div>
                <div class="stat-card"><h3>Ø£ÙƒØ«Ø± 5 Ø¥ÙŠÙ…ÙˆØ¬ÙŠ</h3><ol id="top-emojis"></ol></div>
                <div class="stat-card"><h3>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø£Ø®Ø±Ù‰</h3><div id="media-stats"></div></div>
                <div class="stat-card"><h3>Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø£ÙƒØ«Ø± Ù†Ø´Ø§Ø·Ù‹Ø§</h3><div id="active-day" class="value"></div></div>
                <div class="stat-card"><h3>ğŸ† Ø£Ø·ÙˆÙ„ Ø±Ø³Ø§Ù„Ø©</h3><div id="longest-message"></div></div>
                <div class="stat-card"><h3>ğŸ¥‡ Ø¨Ø§Ø¯Ø¦ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</h3><div id="convo-starter" class="value"></div></div>
                <div class="stat-card"><h3>â±ï¸ Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„Ø±Ø¯</h3><div id="response-time"></div></div>
                <div class="stat-card"><h3>ğŸ“Š Ù…Ù‚ÙŠØ§Ø³ "Ø§Ù„Ø¯à¸±à¸šÙ„ ØªÙƒØ³Øª"</h3><div id="double-text"></div></div>
                <div class="stat-card"><h3>â“ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h3><div id="question-analysis"></div></div>
                <div class="stat-card chart-card"><h3>Ø§Ù„Ù†Ø´Ø§Ø· Ø¹Ù„Ù‰ Ù…Ø¯Ø§Ø± Ø§Ù„Ø´Ù‡ÙˆØ±</h3><canvas id="activity-chart"></canvas></div>
                <div class="stat-card memory-lane-card"><h3>ğŸï¸ Ø´Ø±ÙŠØ· Ø°ÙƒØ±ÙŠØ§Øª</h3><div id="memory-lane"></div></div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const resultsArea = document.getElementById('results-area');
        const actionsArea = document.getElementById('actions-area');
        const exportBtn = document.getElementById('export-btn');
        
        let activityChart;
        let currentStats = {};

        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('drag-over'); });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('drag-over'));
        uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('drag-over'); handleFile(e.dataTransfer.files[0]); });

        function handleFile(file) {
            if (!file || file.type !== 'text/plain') { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ Ù…Ù„Ù .txt ØµØ­ÙŠØ­.'); return; }
            const reader = new FileReader();
            reader.onload = (e) => analyzeChat(e.target.result);
            reader.readAsText(file, 'UTF-8');
        }
        
        function analyzeChat(text) {
            try {
                const lines = text.split(/\r?\n/);
                const messages = [];
                const messageRegex = /^([\d\u0660-\u0669]+[\u200f]?\/[\d\u0660-\u0669]+[\u200f]?\/[\d\u0660-\u0669]+)ØŒ\s([\d\u0660-\u0669]+:[\d\u0660-\u0669]+\s[ØµÙ…])\s-\s[\u200f]?([^:]+):\s(.*)$/;
                
                lines.forEach(line => {
                    const match = line.match(messageRegex);
                    if (match) {
                        const dateParts = toWesternNumerals(match[1].replace(/â€/g, '')).split('/');
                        const timeString = match[2];
                        const timePartsMatch = toWesternNumerals(timeString).match(/(\d+):(\d+)/);
                        if (!timePartsMatch) return;

                        let hour = parseInt(timePartsMatch[1], 10);
                        const minute = parseInt(timePartsMatch[2], 10);

                        if (timeString.includes('Ù…') && hour !== 12) hour += 12;
                        if (timeString.includes('Øµ') && hour === 12) hour = 0;

                        const date = new Date(dateParts[2], dateParts[1] - 1, dateParts[0], hour, minute);
                        
                        if (!isNaN(date)) {
                            messages.push({
                                date: date,
                                author: match[3].trim(),
                                message: match[4].trim()
                            });
                        }
                    }
                });

                if(messages.length === 0) {
                    alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹.");
                    return;
                }
                
                currentStats = processMessages(messages);
                displayResults(currentStats);
            } catch (error) {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù:\n\n' + error);
            }
        }

        function processMessages(messages) {
            const participants = {}; const wordCount = {}; const hourCount = {}; const emojiCount = {};
            const dayCount = Array(7).fill(0); let mediaCount = 0; let linkCount = 0;
            let longestMessage = { author: '', text: '', length: 0 };
            const conversationStarters = {}; let lastDate = null;
            const monthlyActivity = {};
            const responseTimes = {}; const doubleTexts = {}; const questionCounts = {};

            for (let i = 0; i < messages.length; i++) {
                const msg = messages[i];
                participants[msg.author] = (participants[msg.author] || 0) + 1;
                msg.message.split(/[\s\uFEFF\xA0]+/).forEach(word => {
                    const cleanWord = word.toLowerCase().replace(/[.,!?ØŸ<>]/g, '');
                    if (cleanWord && cleanWord.length > 2 && !isStopWord(cleanWord) && isNaN(cleanWord)) {
                        wordCount[cleanWord] = (wordCount[cleanWord] || 0) + 1;
                    }
                });
                hourCount[msg.date.getHours()] = (hourCount[msg.date.getHours()] || 0) + 1;
                const emojis = msg.message.match(/(\p{Emoji_Presentation}|\p{Emoji}\uFE0F)/gu);
                if (emojis) emojis.forEach(emoji => emojiCount[emoji] = (emojiCount[emoji] || 0) + 1);
                if (msg.message.includes('<ØªÙ… Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·>')) mediaCount++;
                if (msg.message.includes('http')) linkCount++;
                const messageDate = msg.date.toDateString();
                if (messageDate !== lastDate) {
                    conversationStarters[msg.author] = (conversationStarters[msg.author] || 0) + 1;
                    lastDate = messageDate;
                }
                dayCount[msg.date.getDay()]++;
                if (msg.message.length > longestMessage.length) {
                    longestMessage = { author: msg.author, text: msg.message, length: msg.message.length };
                }
                const monthYear = `${msg.date.getFullYear()}-${(msg.date.getMonth() + 1).toString().padStart(2, '0')}`;
                monthlyActivity[monthYear] = (monthlyActivity[monthYear] || 0) + 1;
                if (i > 0) {
                    const prevMsg = messages[i-1];
                    if (msg.author !== prevMsg.author) {
                        const diff = (msg.date - prevMsg.date) / 1000;
                        if (!responseTimes[msg.author]) responseTimes[msg.author] = { total: 0, count: 0 };
                        responseTimes[msg.author].total += diff;
                        responseTimes[msg.author].count++;
                    } else {
                        doubleTexts[msg.author] = (doubleTexts[msg.author] || 0) + 1;
                    }
                }
                if (msg.message.includes('ØŸ') || msg.message.includes('?')) {
                    questionCounts[msg.author] = (questionCounts[msg.author] || 0) + 1;
                }
            }

            const avgResponseTimes = {};
            for(const author in responseTimes) { avgResponseTimes[author] = responseTimes[author].total / responseTimes[author].count; }
            return {totalMessages: messages.length, messages, participants, wordCount, hourCount, emojiCount, mediaCount, linkCount, dayCount, longestMessage, conversationStarters, avgResponseTimes, doubleTexts, questionCounts, monthlyActivity};
        }
        
        function displayResults(stats) {
            document.getElementById('total-messages').textContent = stats.totalMessages;
            const participantsList = document.getElementById('participants-list');
            participantsList.innerHTML = '';
            Object.entries(stats.participants).sort((a,b) => b[1] - a[1]).forEach(([author, count]) => {
                const p = document.createElement('p'); p.textContent = `${author}: ${count} Ø±Ø³Ø§Ù„Ø©`; p.style.margin = '5px 0'; participantsList.appendChild(p);
            });
            displayList('top-words', Object.entries(stats.wordCount).sort((a,b) => b[1] - a[1]), (item) => `${item[0]} (${item[1]} Ù…Ø±Ø©)`);
            displayList('top-emojis', Object.entries(stats.emojiCount).sort((a,b) => b[1] - a[1]), (item) => `${item[0]} (${item[1]} Ù…Ø±Ø©)`);
            document.getElementById('media-stats').innerHTML = `<p>Ø§Ù„ÙˆØ³Ø§Ø¦Ø·: <span class="value">${stats.mediaCount}</span></p><p>Ø§Ù„Ø±ÙˆØ§Ø¨Ø·: <span class="value">${stats.linkCount}</span></p>`;
            const dayNames = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
            document.getElementById('active-day').textContent = dayNames[stats.dayCount.indexOf(Math.max(...stats.dayCount))];
            document.getElementById('longest-message').innerHTML = `<p><strong>Ø¨ÙˆØ§Ø³Ø·Ø©:</strong> ${stats.longestMessage.author}</p><div id="longest-message-text">${stats.longestMessage.text}</div>`;
            const topStarter = Object.entries(stats.conversationStarters).sort((a,b) => b[1] - a[1])[0];
            document.getElementById('convo-starter').textContent = topStarter ? topStarter[0] : 'N/A';
            const responseTimeDiv = document.getElementById('response-time');
            responseTimeDiv.innerHTML = '';
            Object.entries(stats.avgResponseTimes).sort((a,b)=>a[1]-b[1]).forEach(([author, avg]) => {
                const p = document.createElement('p'); p.textContent = `${author}: ${formatTime(avg)}`; p.style.margin = '5px 0'; responseTimeDiv.appendChild(p);
            });
            const doubleTextDiv = document.getElementById('double-text');
            doubleTextDiv.innerHTML = '';
            Object.entries(stats.doubleTexts).sort((a,b) => b[1] - a[1]).forEach(([author, count]) => {
                const p = document.createElement('p'); p.textContent = `${author}: ${count} Ù…Ø±Ø©`; p.style.margin = '5px 0'; doubleTextDiv.appendChild(p);
            });
            const questionDiv = document.getElementById('question-analysis');
            questionDiv.innerHTML = '';
            Object.entries(stats.questionCounts).sort((a,b) => b[1] - a[1]).forEach(([author, count]) => {
                const p = document.createElement('p'); p.textContent = `${author}: ${count} Ø³Ø¤Ø§Ù„`; p.style.margin = '5px 0'; questionDiv.appendChild(p);
            });

            renderActivityChart(stats.monthlyActivity);
            renderMemoryLane(stats.messages, stats.longestMessage);
            resultsArea.style.display = 'block';
            actionsArea.style.display = 'block';
        }
        
        function displayList(elementId, items, formatter) {
            const list = document.getElementById(elementId); list.innerHTML = '';
            items.slice(0, 5).forEach(item => {
                const li = document.createElement('li'); li.textContent = formatter(item); list.appendChild(li);
            });
        }
        
        function renderActivityChart(monthlyActivity) {
            const ctx = document.getElementById('activity-chart').getContext('2d');
            const sortedMonths = Object.keys(monthlyActivity).sort();
            if (activityChart) activityChart.destroy();
            activityChart = new Chart(ctx, { type: 'bar', data: { labels: sortedMonths, datasets: [{ label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„', data: sortedMonths.map(month => monthlyActivity[month]), backgroundColor: '#128c7e' }] }, options: { scales: { y: { beginAtZero: true } } } });
        }

        function renderMemoryLane(messages, longestMsg) {
            const memoryLaneDiv = document.getElementById('memory-lane');
            memoryLaneDiv.innerHTML = '';
            if (messages.length === 0) return;

            const memories = [
                { title: 'Ø£ÙˆÙ„ Ø±Ø³Ø§Ù„Ø©', msg: messages[0] },
                { title: 'Ø±Ø³Ø§Ù„Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©', msg: messages[Math.floor(Math.random() * messages.length)] },
                { title: 'Ø£Ø·ÙˆÙ„ Ø±Ø³Ø§Ù„Ø©', msg: { author: longestMsg.author, message: longestMsg.text, date: messages.find(m => m.message === longestMsg.text)?.date } }
            ];

            memories.forEach(mem => {
                if(!mem.msg) return;
                const itemDiv = document.createElement('div');
                itemDiv.className = 'memory-item';
                itemDiv.innerHTML = `
                    <p><strong>${mem.title} (${mem.msg.date ? mem.msg.date.toLocaleDateString('ar-EG') : ''}):</strong></p>
                    <p>"${mem.msg.message}" - <em>${mem.msg.author}</em></p>
                `;
                memoryLaneDiv.appendChild(itemDiv);
            });
        }

        exportBtn.addEventListener('click', () => {
            if (!currentStats.totalMessages) return;
            let report = `ØªÙ‚Ø±ÙŠØ± Ù…Ø­Ø§Ø¯Ø«Ø© ÙˆØ§ØªØ³Ø§Ø¨\n====================\n\n`;
            report += `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: ${currentStats.totalMessages}\n\n`;
            report += `Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ†:\n`;
            Object.entries(currentStats.participants).sort((a,b) => b[1] - a[1]).forEach(([author, count]) => report += `- ${author}: ${count} Ø±Ø³Ø§Ù„Ø©\n`);
            const dayNames = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
            const activeDay = dayNames[currentStats.dayCount.indexOf(Math.max(...currentStats.dayCount))];
            report += `\nØ§Ù„ÙŠÙˆÙ… Ø§Ù„Ø£ÙƒØ«Ø± Ù†Ø´Ø§Ø·Ù‹Ø§: ${activeDay}\n`;
            // ... add more stats to export ...
            
            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'chat_report.txt';
            a.click(); URL.revokeObjectURL(url);
        });

        function formatTime(seconds) {
            if (seconds < 60) return `${Math.round(seconds)} Ø«Ø§Ù†ÙŠØ©`;
            if (seconds < 3600) return `${Math.round(seconds / 60)} Ø¯Ù‚ÙŠÙ‚Ø©`;
            if (seconds < 86400) return `${Math.round(seconds / 3600)} Ø³Ø§Ø¹Ø©`;
            return `${Math.round(seconds / 86400)} ÙŠÙˆÙ…`;
        }

        function toWesternNumerals(str) { return str.replace(/[\u0660-\u0669]/g, d => 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'.indexOf(d)); }
        function isStopWord(word) { const stopWords = new Set(['ÙÙŠ', 'Ù…Ù†', 'Ø¹Ù„Ù‰', 'Ù‡Ùˆ', 'Ù‡ÙŠ', 'Ø§Ù†Ø§', 'Ø§Ù†Øª', 'Ø§Ù†ØªÙŠ', 'ÙƒØ§Ù†', 'ÙŠÙƒÙˆÙ†', 'Ù‡Ø°Ø§', 'Ù‡Ø°Ù‡', 'ÙƒÙ„', 'Ø´ÙŠØ¡', 'Ø§Ùˆ', 'Ùˆ', 'ÙŠØ§', 'Ø§Ù„ÙŠ', 'Ø¹Ù†', 'Ù…Ø§', 'Ù…Ø¹', 'Ø¨Ø³', 'Ø·ÙŠØ¨', 'Ø§ÙŠÙ‡', 'Ø¯Ù‡', 'Ø¯ÙŠ', 'Ù„Ùˆ', 'Ø§Ù†', 'Ø§Ù„ÙŠÙˆÙ…']); return stopWords.has(word); }
    });
    </script>
</body>
</html>

